<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WhitePack Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#f3faf4; margin:0; padding:1.5rem; }
    .card { background:#fff; border-radius:1rem; padding:1.5rem; max-width:820px; margin:0 auto; box-shadow:0 10px 30px rgba(14,159,110,.05); border:1px solid rgba(47,158,68,.04); }
    h1 { margin-top:0; }
    input[type=file] { margin:1rem 0; }
    button { background:#2f9e44; color:#fff; border:none; padding:.6rem 1.2rem; border-radius:.6rem; cursor:pointer; }
    button.secondary { background:#e2e8f0; color:#0f172a; }
    .log { margin-top:1rem; font-size:.85rem; background:#0f172a; color:#e2e8f0; padding:.5rem .8rem; border-radius:.5rem; white-space:pre-wrap; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; gap:1rem; }
    a { color:#2f9e44; }
    label { display:block; margin-top:1rem; font-weight:600; }
    input[type=number], input[type=text] {
      width:100%; padding:.4rem .5rem; border:1px solid #cbd5f5; border-radius:.5rem; margin-top:.4rem;
    }
    .row { display:flex; gap:1rem; flex-wrap:wrap; }
    .col { flex:1 1 200px; }
    #langBtn { background:#ecfdf3; color:#166534; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="card" id="main" dir="ltr">
    <div class="topbar">
      <h1 id="title">WhitePack Catalogue Admin</h1>
      <div style="display:flex; gap:.5rem; align-items:center;">
        <a id="openCat" href="index.html" target="_blank">➡ Open Catalogue</a>
        <button id="langBtn">AR</button>
      </div>
    </div>
    <p id="desc">Upload Excel (.xlsx/.csv) with these headers:</p>
    <p><code>SKU, Name, Name_ar, Category, Category_ar, Description, Description_ar, Price, Quantity, Image, WhatsApp</code></p>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />

    <div class="row">
      <div class="col">
        <label id="rateLabel">USD → LBP rate (manual)</label>
        <input type="number" id="rate" placeholder="e.g. 90000" min="0" step="100" />
      </div>
      <div class="col" style="display:flex; gap:.5rem; align-items:end;">
        <button id="saveRateBtn" style="width:100%;">Save rate</button>
      </div>
    </div>

    <p id="note" style="margin-top:1rem; font-size:.85rem; color:#64748b;">Rate will be stored in browser and used by index.html.</p>

    <button id="exportBtn" class="secondary">Export products.json</button>
    <button id="clearBtn" class="secondary">Clear data (local)</button>

    <div class="log" id="log">Waiting for file...</div>
  </div>

  <script>
    const STORAGE_KEY = "internal_catalogue_products_v3"; // local copy for admin
    const RATE_KEY = "internal_catalogue_usd_to_lbp";
    let currentLang = "en";

    const UI = {
      title: {
        en: "WhitePack Catalogue Admin",
        ar: "لوحة تحكم كتالوج وايت باك"
      },
      desc: {
        en: "Upload Excel (.xlsx/.csv) with these headers:",
        ar: "حمّل ملف إكسل (.xlsx/.csv) بهذه العناوين:"
      },
      rateLabel: {
        en: "USD → LBP rate (manual)",
        ar: "سعر الصرف من دولار إلى ليرة (يدوي)"
      },
      note: {
        en: "Rate will be stored in browser and used by index.html.",
        ar: "سيتم حفظ السعر في المتصفح وسيستخدمه ملف index.html."
      },
      exportBtn: {
        en: "Export products.json",
        ar: "تصدير products.json"
      },
      clearBtn: {
        en: "Clear data (local)",
        ar: "مسح البيانات (محلياً)"
      },
      openCat: {
        en: "➡ Open Catalogue",
        ar: "➡ فتح الكتالوج"
      }
    };

    function applyLang(){
      document.getElementById("main").dir = currentLang === "ar" ? "rtl" : "ltr";
      document.getElementById("title").textContent = UI.title[currentLang];
      document.getElementById("desc").textContent = UI.desc[currentLang];
      document.getElementById("rateLabel").textContent = UI.rateLabel[currentLang];
      document.getElementById("note").textContent = UI.note[currentLang];
      document.getElementById("exportBtn").textContent = UI.exportBtn[currentLang];
      document.getElementById("clearBtn").textContent = UI.clearBtn[currentLang];
      document.getElementById("openCat").textContent = UI.openCat[currentLang];
      document.getElementById("langBtn").textContent = currentLang === "en" ? "AR" : "EN";
    }

    const rateInput = document.getElementById("rate");
    const savedRate = localStorage.getItem(RATE_KEY);
    if(savedRate){
      rateInput.value = savedRate;
    }

    function log(msg){
      document.getElementById("log").textContent = msg;
    }

    document.getElementById("fileInput").addEventListener("change", handleFile, false);
    document.getElementById("exportBtn").addEventListener("click", exportData);
    document.getElementById("clearBtn").addEventListener("click", () => {
      localStorage.removeItem(STORAGE_KEY);
      log(currentLang === "ar" ? "تم مسح البيانات من هذا المتصفح." : "Data cleared from this browser.");
    });
    document.getElementById("saveRateBtn").addEventListener("click", () => {
      const v = rateInput.value || "";
      localStorage.setItem(RATE_KEY, v);
      log((currentLang === "ar" ? "تم حفظ السعر: " : "Rate saved: ") + "1 USD = " + v + " LBP");
    });
    document.getElementById("langBtn").addEventListener("click", () => {
      currentLang = currentLang === "en" ? "ar" : "en";
      applyLang();
    });

    function handleFile(e){
      const file = e.target.files[0];
      if(!file){ return; }
      const reader = new FileReader();
      reader.onload = function(e){
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type:'array'});
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, {defval:""});
        const products = json.map((row, i) => ({
          sku: row.SKU || row.sku || ("SKU-" + (i+1)),
          name: row.Name || row.name || "",
          name_ar: row.Name_ar || row.name_ar || "",
          category: row.Category || row.category || "",
          category_ar: row.Category_ar || row.category_ar || "",
          description: row.Description || row.description || "",
          description_ar: row.Description_ar || row.description_ar || "",
          price: row.Price || row.price || "",
          quantity: row.Quantity || row.quantity || "",
          image: row.Image || row.image || "",
          whatsapp: row.WhatsApp || row.whatsapp || ""
        }));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
        log((currentLang === "ar" ? "تم استيراد " : "Imported ") + products.length + (currentLang === "ar" ? " منتج." : " products."));
      };
      reader.readAsArrayBuffer(file);
    }

    function exportData(){
      const raw = localStorage.getItem(STORAGE_KEY) || "[]";
      const products = JSON.parse(raw);
      const blob = new Blob([JSON.stringify(products, null, 2)], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "products.json";
      a.click();
      URL.revokeObjectURL(url);
      log(currentLang === "ar" ? "تم تحميل ملف products.json. ارفعه إلى GitHub." : "products.json downloaded. Upload it to GitHub.");
    }

    applyLang();
  </script>
</body>
</html>
