<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WhitePack Admin Panel (Always Export)</title>
<style>
body{
  font-family: Arial, sans-serif;
  background:#f5fff8;
  color:#213;
  margin:0;
  padding:20px;
}
h1{color:#2e7d32;}
.card{
  background:#fff;
  padding:20px;
  border-radius:10px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
  margin-bottom:20px;
}
label{font-weight:bold;}
input,button{
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:14px;
}
input{width:100%;margin-top:4px;margin-bottom:12px;}
button{
  background:linear-gradient(90deg,#6ecf6e,#3b7a3a);
  color:#fff;
  border:none;
  padding:10px 14px;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
}
button:hover{opacity:.9;}
.note{
  background:#e8f5e9;
  padding:10px;
  border-left:4px solid #43a047;
  border-radius:8px;
  font-size:13px;
}
textarea{
  width:100%;
  height:220px;
  font-family:monospace;
  font-size:13px;
  border-radius:8px;
  border:1px solid #ccc;
  padding:10px;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>

<h1>üì¶ WhitePack Admin Panel ‚Äî Always Export</h1>

<div class="card">
  <h3>Step 1Ô∏è‚É£ ‚Äî Upload Excel file</h3>
  <input type="file" id="excelFile" accept=".xlsx,.xls" />
  <div class="note">Headers required: <b>SKU, Name, Name_ar, Category, Category_ar, Description, Description_ar, Price, Quantity, Image, WhatsApp</b></div>
</div>

<div class="card">
  <h3>Step 2Ô∏è‚É£ ‚Äî Settings</h3>
  <label>üíµ USD ‚Üí LBP Rate:</label>
  <input type="number" id="rateInput" value="90000" step="100" />
  <label>üì± WhatsApp Number:</label>
  <input type="text" id="waInput" value="96170333029" />
  <button onclick="saveSettings()">Save Settings</button>
  <div class="note">Saved locally ‚Äî used when you export.</div>
</div>

<div class="card">
  <h3>Step 3Ô∏è‚É£ ‚Äî Export JSON</h3>
  <button onclick="exportJSON()">Export products.json</button>
  <div class="note">If the file doesn‚Äôt auto-download, it will open in a new tab so you can <b>Ctrl+S ‚Üí Save As products.json</b>.</div>
</div>

<div class="card">
  <h3>üìÑ Preview JSON</h3>
  <textarea id="jsonOutput" readonly></textarea>
</div>

<script>
function saveSettings(){
  localStorage.setItem('internal_catalogue_usd_to_lbp',document.getElementById('rateInput').value);
  localStorage.setItem('whitepack_whatsapp_number',document.getElementById('waInput').value);
  alert('‚úÖ Settings saved');
}

let excelData=[];
document.getElementById('excelFile').addEventListener('change',handleExcel,false);
function handleExcel(evt){
  const file=evt.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    const data=new Uint8Array(e.target.result);
    const workbook=XLSX.read(data,{type:'array'});
    const sheet=workbook.Sheets[workbook.SheetNames[0]];
    excelData=XLSX.utils.sheet_to_json(sheet,{defval:""});
    alert('‚úÖ Excel loaded ‚Äî Rows: '+excelData.length);
  };
  reader.readAsArrayBuffer(file);
}

function exportJSON(){
  if(!excelData.length){alert('Upload an Excel file first!');return;}

  const mapped=excelData.map(row=>{
    const normalize=k=>k?k.trim().toLowerCase():"";
    const keys=Object.keys(row).reduce((a,k)=>{a[normalize(k)]=k;return a;},{});
    const num=v=>isNaN(parseFloat(v))?0:parseFloat(v);
    const int=v=>isNaN(parseInt(v))?0:parseInt(v);
    return{
      sku:row[keys["sku"]]||"",
      name:row[keys["name"]]||"",
      name_ar:row[keys["name_ar"]]||"",
      category:row[keys["category"]]||"",
      category_ar:row[keys["category_ar"]]||"",
      description:row[keys["description"]]||"",
      description_ar:row[keys["description_ar"]]||"",
      price:num(row[keys["price"]]||row[keys["price usd"]]||row[keys["priceusd"]]||row[keys["prix"]]),
      quantity:int(row[keys["quantity"]]||row[keys["qty"]]||row[keys["qte"]]),
      image:row[keys["image"]]||"",
      whatsapp:row[keys["whatsapp"]]||""
    };
  });

  const json=JSON.stringify(mapped,null,2);
  document.getElementById('jsonOutput').value=json;

  try{
    const blob=new Blob([json],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="products.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert('‚úÖ Download started');
  }catch(e){
    const newTab=window.open();
    newTab.document.write('<pre>'+json.replace(/</g,"&lt;")+'</pre>');
  }
}
</script>
</body>
</html>
